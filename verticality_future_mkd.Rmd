---
bibliography: "`r rbbt::bbt_write_bib('docs/r-refs.bib', overwrite = TRUE)`"
csl: global-ecology-and-biogeography.csl
output: 
  officedown::rdocx_document:
    reference_docx: "style-guide.docx"
    mapstyles:
      Normal: ['First Paragraph']
plots:
  caption:
    style: Image Caption
    pre: 'Figure '
    sep: ': '
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \rhead{Global Verticality}
- \begin{document}
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE, warning=FALSE, message=FALSE, error=FALSE)
library(officedown)
library(officer)
library(tidyverse)
library(spatialreg)
library(data.table)
library(flextable)
library(knitr)
library(chunkhooks)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)

hook_figure_unit("mm")
```


```{r}
word_comment <- function(
  comment, 
  highlight = "", 
  author = "Lydia", 
  time = Sys.time(),
  id = "0"
) 
{
  if (isTRUE(knitr:::pandoc_to() == "docx")) {
    return(
      sprintf(
        '[%s]{.comment-start id="%s" author="%s" date="%s"} %s []{.comment-end id="%s"}',
        comment,
        id,
        author,
        time,
        highlight,
        id
      )
    )
  } else {
    return(
      sprintf(
        "*%s* **[Comment id %s by %s at time %s: %s]**", 
        highlight,
        id,
        author, 
        time, 
        comment
      )
    )
  }
}
```

**Global patterns and drivers of vertebrate verticality**

Lydia G. Soifer^1\*^, David P. Edwards^2,3^, Brunno F Oliveira^4,5^, Mario R Moura^6^, Brett R. Scheffers^4^

1 School of Natural Resource and Environment, University of Florida, USA

2 Department of Plant Sciences and Centre for Global Wood Security, University of Cambridge, Cambridge, UK

3 Conservation Research Institue, University of Cambridge, Cambridge, UK

4 Centre de Synthèse et d’Analyse sur la Biodiversité, Montpellier, France

5 Department of Wildlife Ecology and Conservation, University of Florida, USA

6 Departamento de Sistemática e Ecologia, Universidade Federal da Paraíba, João Pessoa, Brazil


Email addresses:

^\*^ lysoifer@gmail.com (corresponding author)

dpe29@cam.ac.uk

brunno.oliveira@me.com

mariormoura@gmail.com

brett.scheffers@ufl.edu


**Funding Statement**

LGS was funded by the National Science Foundation Graduate Research Fellowship. This material is based upon work supported by the National Science Foundation Graduate Research Fellowship under Grant No. DGE1842473. Any opinions, findings, and conclusions or recommendations expressed in this material are those of the authors and do not  necessarily reflect the views of the National Science Foundation.

**Conflicts of Interest**

The authors have no conflicts of interest.

\newpage

**Global patterns and drivers of vertebrate verticality**

**Abstract**

**Aim**: Vertical stratification of species from the ground to canopy is posited as a mechanistic link explaining positive relationships between canopy height and species richness. A key question is understanding how climate and vegetation impact verticality and spatial variation in verticality-diversity patterns. We examine these relationships and then project models of verticality under future climate conditions to examine how climate change may impact vertical community structure.

**Location**: Global

**Time period**: 1981-2010 to 2071-2100

**Major taxa studied**: Vertebrates

**Methods**: We modeled impacts of climate and vegetation on vertebrate verticality globally using spatial generalized linear mixed models with a spatially varying coefficient for canopy height. We projected models to future climate conditions to examine impacts of climate change on vertical community structure. We also examined global and biome-specific relationships between verticality and species richness.

**Results**: Verticality patterns are globally consistent across vertebrate taxa, declining from low to high latitudes. Low precipitation and temperature constrain verticality outside moist tropical regions. Globally, positive relationships occurred between canopy height and verticality and between verticality and richness (except for reptiles). Regionally, canopy height exhibited largely neutral impacts on verticality, while verticality-richness relationships varied from negative or weakly positive in temperate and boreal biomes to generally positive in tropical biomes. Model projections indicated relatively small changes in verticality under future climate conditions.

**Main conclusions**: Physiological constraints to arboreal lifestyles limit verticality in cold and dry macroclimate conditions. Globally, vertical stratification across increasingly tall forests (niche expansion) contributes to high richness in tropical regions. Regionally, climatic constraints limit positive verticality-richness relationships in higher latitudes, while niche packing largely contributes to positive verticality-richness relationships in tropical regions. Small changes to vertical community structure at a global scale could be caused by arboreal species increasing their use of understory habitat, becoming extirpated, or shifting geographic ranges to higher latitudes.

\newpage

# Introduction

In forest ecosystems, species assemblages stratify vertically along resource and climate gradients that extend from beneath the ground to the top of the canopy, a phenomenon called vertical stratification [@bashamVerticalStratificationPatterns2023a; @xingEcologicalPatternsProcesses2023a]. Tall, multi-layered forests increase both habitat volume and niche opportunities, enabling species to partition across vertical strata akin to multi-floored apartments [Fig. \@ref(fig:concept-fig)a; @macarthurLimitingSimilarityConvergence1967; @macarthurBirdSpeciesDiversity1961; @larueDiversityVolumeRelationships2023]. This vertical stacking of species has been described as a mechanistic link between canopy height and species richness [@culbertInfluenceVerticalHorizontal2013; @fengForestCanopyHeight2020; @gillespieDistributionBirdSpecies2001; @oliveiraVerticalStratificationInfluences2019; @wagnerRemotelySensedTree2023], and is thought to contribute to the exceptionally high biodiversity in the tropics via niche expansion processes [@macarthurPopulationEcologyWarblers1958; @macarthurBirdSpeciesDiversity1961; @oliveiraVerticalStratificationInfluences2019; @bashamVerticalStratificationPatterns2023a]. Thus, as the amount of habitat space increases with forest height, species may be added to the assemblage, increasing richness relative to shorter forests [Fig. \@ref(fig:concept-fig); @pellissierNichePackingExpansion2018; @pigotFunctionalTraitsReveal2016]. However, canopy height does not consistently impact species richness at regional to global scales, with weaker relationships observed at high latitudes where verticality is lower [@larueDiversityVolumeRelationships2023; @rollLinkingVertebrateSpecies2015; @oliveiraVerticalStratificationInfluences2019]. Whether animal verticality plays a central role in driving richness gradients globally remains an open question, and surprisingly little progress has been made in assessing whether this relationship holds across multiple taxonomic groups with differing sensitivities to climate variability.

Tall forests exhibit steep vertical climate gradients, characterized by high maximum temperatures, low minimum temperatures, and reduced moisture availability in the canopy and lower thermal variability and higher moisture availability toward the ground [@scheffersTropicalMountainPasses2018; @leahyVerticalNicheElevation2021; @defrenneGlobalBufferingTemperatures2019]. In wet tropical forests, macroclimate conditions produce warmer and wetter canopy microclimates, which reduce thermal and hydric stress and may allow species to stratify across the entire vertical habitat gradient, partitioning niche space for nesting and food resources [@oliveiraVerticalStratificationInfluences2019]. Taller canopies in tropical regions could thus support higher animal verticality and richness (Fig. \@ref(fig:concept-fig)). In contrast, at temperate and boreal latitudes, macroclimate conditions, including low temperature and precipitation, may cause canopy microclimates to exceed physiological thresholds for many species, often constraining them to lower vertical positions [@oliveiraVerticalStratificationInfluences2019; @bakenSalamanderArborealityLimited2021]. As a result, taller canopies in these regions do not necessarily provide additional vertical habitat opportunities or support higher verticality and richness, as harsh macroclimate conditions limit the suitability of vertical habitat space (Fig. \@ref(fig:concept-fig)). We therefore expect a globally varying relationship between animal verticality and two key factors: canopy height and species richness. These relationships are likely to depend on baseline regional conditions, ranging from positive in tropical ecosystems to neutral in temperate and boreal regions.

Since animal verticality is influenced by both climate and vegetation structure, changing climatic conditions may alter constraints on arboreal life strategies, potentially reshaping assemblage verticality and its association with species richness. In tropical lowlands, novel high temperatures [@trewNovelTemperaturesAre2024] may impose physiological stress on arboreal animals, leading them to disperse toward higher elevations, lower vertical habitats, or become locally extirpated [@scheffersIncreasingArborealityAltitude2013; @oliveiraVerticalStratificationInfluences2019]. These scenarios would reduce assemblage verticality in the lowlands, mirroring documented climate-driven shifts in assemblage thermal tolerance [@feeleyClimatedrivenChangesComposition2020; @lajeunesseTemporalAnalysisGBIF2023; @chustCrossbasinCrosstaxaPatterns2024; @borderieuxExtinctionDrivesRecent2024]. In contrast, at higher latitudes, warming minimum temperatures may alleviate climatic constraints on arboreal species, promoting range expansions that could increase assemblage verticality. These contrasting dynamics underscore the need for further investigation into how climate-driven changes influence the vertical structure of assemblages and its impacts on biodiversity gradients.


```{r}
birds = read.csv("data/derivative_data/species_data/birds_spdat_elton_forestsOnly.csv")
mammals = read.csv("data/derivative_data/species_data/mammals_spdat_moura_forestsOnly.csv")
amph = read.csv("data/derivative_data/species_data/amph_spdat_moura_forestsOnly.csv")
repts = read.csv("data/derivative_data/species_data/rept_spdat_moura_forestsOnly.csv")

nbirds = nrow(birds)
nmammals = nrow(mammals)
namph = nrow(amph)
nrept = nrow(repts)
```

Despite decades of ecological inquiry into the relationships between verticality and species richness, key aspects remain poorly understood for terrestrial vertebrates. These include global patterns of verticality, their environmental drivers, and the mechanisms linking verticality and species richness. To improve our understanding of the relationships between climate, vegetation structure, verticality, and species richness, we integrate range maps of nearly 24,000 vertebrate species with climate and vegetation data to examine global patterns and drivers of verticality in wooded biomes, as well as relationships between verticality and species richness. We ask 1) how do climate and vegetation structure impact verticality and does the impact of canopy height vary spatially, 2) how do relationships between verticality and richness vary across biomes, and 3) how might climate change impact global patterns of verticality?

# Methods


```{r}
mammals = fread("data/derivative_data/gridcell_data/env_forest/50_km/mammals_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

birds = fread("data/derivative_data/gridcell_data/env_forest/50_km/birds_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

amphibians = fread("data/derivative_data/gridcell_data/env_forest/50_km/amph_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

rept = fread("data/derivative_data/gridcell_data/env_forest/50_km/reptiles_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)


mammals.arb.tropicalmoist = round(mean(mammals$p.arb[mammals$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
birds.arb.tropicalmoist = round(mean(birds$p.arb[birds$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
rept.arb.tropicalmoist = round(mean(rept$p.arb[rept$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
amphibians.arb.tropicalmoist = round(mean(amphibians$p.arb[amphibians$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)

```

## Species data

We mapped global verticality and richness of terrestrial vertebrate assemblages in wooded habitats [@dinersteinEcoregionBasedApproachProtecting2017] within 50-km grid cells and using a cylindrical equal area projection (Supplementary Methods). Grid cells with fewer than five species were excluded, because they may reduce the performance of null models. Range maps were obtained from the IUCN Red List for mammals and amphibians [@iucnIUCNRedList2023], BirdLife International for birds [@birdlifeinternationalandhandbookofthebirdsoftheworldBirdSpeciesDistribution2022; using breeding plus resident ranges], and the Global Assessment of Reptile Distributions (GARD) for reptiles [@rollGlobalDistributionTetrapods2017; @caetanoAutomatedAssessmentReveals2022]. Overall, we obtained range maps for `r nbirds` birds, `r nmammals` mammals, `r nrept` reptiles, and `r namph` amphibians.

To calculate the verticality of each assemblage (i.e., grid cell), we assigned each species a verticality score from zero to one and then took the average verticality of all species whose ranges overlapped with the grid cell. For mammals, reptiles, and amphibians, verticality scores were based on their use of fossorial (0), terrestrial (0.5), and arboreal (1) habitats as defined in the TetrapodTraits database [@mouraPhylogenyinformedCharacterisationGlobal2024]. For birds, we calculated verticality scores based on their use of different foraging strata as identified in the EltonTraits database [@wilmanEltonTraitsSpecieslevelForaging2014], which provides a finer scale vertical classification than the dataset from Moura et al. [-@mouraPhylogenyinformedCharacterisationGlobal2024]. We classified foraging below the water surface, around the water surface, and on the ground as 0.5, in the understory as 0.667, mid-high canopy as 0.8337, and in or above the upper canopy as 1. If species used multiple vertical habitats, vertical scores were averaged. For example, if a species occurred in terrestrial (0.5) and arboreal (1) habitats, it would receive a verticality score of 0.75. Species that occupied only aerial vertical niches or that did not occur in terrestrial habitats were excluded from the analysis.

To examine spatial patterns of assemblage verticality independently of species richness, we calculated the standard effect size (SES) of mean verticality: $SES = (x_i - \bar{x})/sd(x)$, where x is a vector of expected mean verticality scores given random selection of species from a species pool. For each vertebrate class, we defined species pools as all species inhabiting wooded habitats within a given biogeographic realm [@dinersteinEcoregionBasedApproachProtecting2017] and generated a null distribution of expected verticality for each grid cell based on 100 simulations. For each simulation, we randomized verticality within the grid cell by randomly drawing the same number of verticality scores from the respective species pool as the observed richness in the cell. Highly positive SES verticality scores represent assemblages having much higher verticality than expected given the species richness, while low SES verticality scores represent assemblages having much lower verticality than expected given the species richness.

## Environmental data

We used 11 variables to represent variation in environmental conditions. Climate data were represented with seven predictors: (i) mean daily maximum air temperature of the warmest month (Tmax warm), (ii) mean daily minimum air temperature of the coldest month (Tmin cold), (iii) temperature seasonality (Temp sea), (iv) precipitation of the wettest month (Precip wet), (v) precipitation of the driest month (Precip dry), (vi)  precipitation seasonality, and (vii) mean monthly precipitation of the warmest quarter [@kargerDataClimatologiesHigh2021; @kargerClimatologiesHighResolution2017]. All climatic variables were extracted from CHELSA v2.1 (30 arc-second resolution) for both current (1981-2010) and future (2071-2100) periods, the later represented by an ensemble of the five general circulation models in CHELSA CMIP6 ISIMIP3 data projected under the Shared Socioeconomic Pathway (SSP) 585. Vegetation data included (viii) canopy height [@langHighresolutionCanopyHeight2023], (ix) vegetation density [@crowtherMappingTreeDensity2015], and (x) vegetation complexity (the product of canopy height and vegetation density). Additionally, we included (xi) historical climate velocity (0.25° resolution), which represents the average rate at which thermal isotherms have shifted between the last glacial maximum and present climate conditions [@sandelInfluenceLateQuaternary2011] and influences global patterns of verticality [@oliveiraVerticalStratificationInfluences2019]. All environmental data were resampled to the spatial resolution and projection of the species data.

## Analysis

### Variable selection
We examined relationships between mean verticality and SES verticality and the ten environmental variables. To linearize the relationships between predictor and response variables, we log10-transformed climate velocity and precipitation of the driest month. We then scaled all predictor variables to mean zero and variance one and examined their multicollinearity using the Variation Inflation Factor (VIF). We iteratively removed the predictor variables until all VIFs were less than five [@wartonEcostatsDataAnalysis2022]. We chose variables to remove based on a combination of which had the highest VIF and which were most likely to directly impact physiological limits to arboreality. For example, we excluded precipitation seasonality because it was strongly correlated with dry season precipitation and has a less direct impact on physiological limits to verticality than dry season precipitation. This procedure resulted in a final set of seven variables that included canopy height, vegetation density, maximum temperature of the warmest month, minimum temperature of the coldest month, precipitation of the wettest month, precipitation of the driest month, and climate velocity. The additive effects of these variables were included as fixed effects in the model in addition to a quadratic term for maximum temperature of the warmest month, as we expected that verticality may increase with temperature up to a certain point but then decline under extremely high temperatures.

### Model description

We used spatial generalized linear mixed-effects models (GLMMs) to evaluate the impact of environmental variables on mean and SES verticality. Spatial models were fit using the R package sdmTMB [@andersonSdmTMBPackageFast2024], which fits models using maximum marginal likelihood estimation through template model builder (TMB) and uses the stochastic partial differential equation (SPDE) approach to approximate spatial Gaussian random fields [@lindgrenExplicitLinkGaussian2011] as implemented in R-INLA [@lindgrenBayesianSpatialModelling2015]. sdmTMB is also able to fit models that include a spatially varying coefficient (SVC), which allow the coefficient of a predictor variable to vary across the study extent and are better able to detect complex species-environment relationships [@doserGuidelinesUseSpatially2024; @andersonSdmTMBPackageFast2024].

The general model can be described as: 

$$
\begin{align}
y_s ∼ 𝜇_{s}, \\
𝜇_s = 𝑓^{-1}(𝜲^{main}_s𝛽 + α_g + 𝜲^{svc}_sζ_s + ⍵_s), \\
⍵_s ∼ MVNormal(0,𝚺_⍵)
\end{align}
$$

where $y_s$ is mean or SES verticality at location $s$ defined by x and y coordinates, $𝜇_s$ is the expected mean or SES verticality, and $𝑓^{-1}$ represents an inverse link function. We modeled SES verticality as a normal distribution and mean verticality as a beta distribution with a logit link function because values are constrained between 0 and 1. $𝜲^{main}_s$ is a vector of main effect covariates and 𝛽 represents a corresponding vector of estimated main effect coefficients. $α_g$ represents a random intercept defined by biogeographic realm [@dinersteinEcoregionBasedApproachProtecting2017], which accounts for potential variation in verticality driven by global evolutionary patterns. $⍵_s$ represents a spatial random field at location $s$, and describes additional spatial variation in the data not explained by the environmental covariates or random intercept. $𝜲^{svc}_sζ_s$ represents a spatially varying coefficient, where $𝜲^{svc}$ represents the vector of spatially varying parameter values and $ζ_s$ represents the spatially varying coefficients, which are described using a random field such that the coefficients follow a multivariate normal distribution with mean zero and covariance ($𝚺_ζ$). 

Both the spatial random field and the spatially varying coefficients were modeled as Gaussian random fields with a covariance matrix modeled by the Matérn covariance function, which defines the decay rate of correlation with distance. Gaussian random fields were approximated for models of mean and SES verticality for each taxa using a spatial mesh optimized such that the edge length was as large as possible to reduce computational time while remaining less than five times the spatial range of the model [@andersonSdmTMBPackageFast2024; @krainskiAdvancedSpatialModeling2019] (Supplementary methods). The model is specified such that both spatial terms share the same range parameter.

### Model comparison and evaluation

For each taxonomic group and verticality metric (i.e., mean or SES verticality), we used restricted maximum likelihood (REML) to fit models with four different random effects structure [@zuurMixedEffectsModels2009]. The base model only included a spatial random field. Subsequent models additionally included biogeographic realm (sensu @dinersteinEcoregionBasedApproachProtecting2017) as a random intercept, a spatially varying coefficient (SVC) for canopy height, and the combination of both. The SVC allows the impact of canopy height on verticality to vary globally, enabling us to test the hypothesis that canopy height has a positive effect on verticality only where climatic conditions support arboreality. 

We compared models using AIC and cross-validation. AIC is frequently used to identify the most parsimonious model (e.g., @barnettImprovingEstimatesSpecies2021); however, the metric is not completely appropriate for hierarchical models [@commanderShadowModelHow2022]. Therefore, we additionally used cross-validation to evaluate out-of-sample predictive ability [@commanderShadowModelHow2022]. We randomly assigned each data point to one of five folds, and then iteratively fit the model using four of the five folds while one fold was withheld for testing. The sum of the log-likelihoods for each left-out fold provides a measure of predictive ability that is compared across models. Cross validation was conducted using the ‘sdmTMB_cv’ function from the sdmTMB package. Models that included both a spatially varying coefficient for canopy height and geographic realm as a random intercept consistently had the lowest AIC value across all models, while model performance varied based on cross validation (Table S\@ref(tab:mod-compare-tab)). Given consistent performance based on AIC and our interest in the SVC, all predictions were made based on the model including an SVC for canopy height and a random effect of realm.

We validated models first using the ‘sanity’ function from the sdmTMB package. We additionally calculated quantile residuals using the DHARMa R package [@hartigDHARMaResidualDiagnostics2022] to assess residual normality and lack of patterning across space.

We estimated uncertainty of SVCs for canopy height by adding draws of the SVC random field to draws of the fixed effect parameter for canopy height across 300 simulations. From these draws, we calculated the median and a 95% confidence interval bounded by 2.5% and 97.5% quantiles. Confidence intervals that did not overlap zero were considered significant [@andersonSdmTMBPackageFast2024].

## Relationships between verticality and richness

We fit linear models of richness as a function of SES or mean verticality for all assemblages as well as for assemblages in each biome [@dinersteinEcoregionBasedApproachProtecting2017]. Biomes with fewer than 30 assemblages were not included.

## Future predictions

To examine potential impacts of climate change on assemblage verticality, we used the models to project mean and SES verticality under a future climate scenario. We held vegetation variables constant at present-day values due to lack of global predictions of future canopy height and vegetation density. We calculated the verticality change by subtracting present-day predictions, based on current climate, from the future projections. These differences were then standardized to reflect the  relative change in mean and SES verticality:

$relative change = (verticality_{future,t,i} - verticality_{present,t,i})/(verticality_{max,t} - verticality_{min, t})*100$, where t indicates a given taxon and i indicates a given grid cell. Negative values indicate predicted declines in verticality and positive values indicate predicted increases in verticality.

# Results

## Global patterns of verticality

The standard effect size (SES) of verticality and mean verticality exhibited latitudinal gradients across taxa characterized by high verticality in the tropics and lower verticality toward poleward latitudes (Fig. \@ref(fig:vert-map-global)). These patterns were largely driven by declines in the proportion of arboreal species toward the poles (Fig. \@ref(fig:vert-map-global)).

Within tropical and subtropical biomes, verticality across taxa was highest in moist forests and lowest in dry forests (Fig. S\@ref(fig:vert-biome)). In moist forests, verticality of bird and mammal assemblages was consistently high globally, with an average of `r birds.arb.tropicalmoist`% of birds and `r mammals.arb.tropicalmoist`% of mammals exhibiting arboreal strategies. In contrast, amphibian and reptile verticality exhibited clear hotspots, with reptile verticality peaking in Madagascar and Indo-Malay forests and amphibian verticality peaking in the Brazilian Atlantic forest and eastern Madagascar (Fig. \@ref(fig:vert-map-global)).

In temperate biomes, verticality was lower in less-dense wooded habitats (e.g., savannas and shrublands) (Fig. S\@ref(fig:vert-biome)). Additionally, the proportion of species exhibiting fossorial strategies largely influenced differences in verticality among vertebrate classes in temperate regions. Amphibians exhibited the highest proportion of fossorial strategies in temperate biomes (Fig. \@ref(fig:vert-map-global)L), followed by mammals (Fig. \@ref(fig:vert-map-global)F), although amphibians in temperate rainforests (e.g., the Pacific-Northwest of North America) had relatively high verticality. In contrast, the proportion of fossorial reptiles declined in temperate regions, with low verticality driven by declines in the proportion of arboreal species and increases in the proportion of terrestrial species. Though no birds exhibit fossorial strategies, a reduction in the proportion of arboreal species still produced a steep latitudinal verticality gradient (Fig. \@ref(fig:vert-map-global)).

## Environmental drivers of verticality

Spatial GLMMs indicated that mean and SES verticality were limited by dry and, to some extent, wet season precipitation, while impacts of maximum temperatures, minimum temperatures, and canopy height varied across taxa (Fig. \@ref(fig:mod-coefs)). Specifically, the minimum temperature of the coldest month positively impacted mean and SES verticality of mammals and reptiles, but did not significantly impact birds and amphibians. Maximum temperatures of the warmest month exhibited a quadratic relationship with mean and SES verticality of birds, reptiles, and amphibians, while exhibiting a positive linear relationship with mammal verticality. The negative effects of high and low maximum temperatures were most pronounced under dry conditions (Fig. S\@ref(fig:condeff-mean),\@ref(fig:condeff-ses)). These patterns led to lower mean and SES verticality at both high and low maximum temperatures in regions with low dry season precipitation for reptiles and amphibians, while verticality increased with maximum temperature across varying levels of dry season precipitation for birds and mammals (Fig. S\@ref(fig:condeff-mean),\@ref(fig:condeff-ses)).

Canopy height had globally significant positive impacts on SES verticality of reptiles and amphibians and mean verticality of amphibians, and trended toward a positive impact for mammals, birds, and mean verticality of reptiles. Vegetation density had no significant impact on mean or SES verticality for any taxon (Fig. \@ref(fig:mod-coefs)). Notably, the impact of canopy height varied spatially. Despite exhibiting neutral impacts on verticality across most regions globally, canopy height positively impacted verticality in tropical regions with greater topographic relief, such as the Andes, southern India, east-central Africa including the Eastern Arc Mountain Range, and Madagascar (Fig. \@ref(fig:svc)). 

## Verticality-species richness relationships

Linear models indicated globally positive relationships between richness and mean or SES verticality across all taxa (Fig. \@ref(fig:richness-mods)). However, R^2^ values indicated generally weaker global relationships for reptiles and amphibians than for birds and mammals. When restricted to individual biomes, boreal and temperate regions generally exhibited negative or weak positive slopes, while tropical regions generally exhibited stronger positive slopes (Fig. \@ref(fig:richness-mods), S\@ref(fig:cor-biome)). However, reptiles deviated from this pattern, exhibiting weak positive or negative slopes between richness and verticality in the tropics (Fig. \@ref(fig:richness-mods), S\@ref(fig:cor-biome)).

## Climate change impacts

```{r cache=TRUE, cache.path="cache/"}
# calculate percent change in verticality
#source("./../scripts/04_plots/vertdif_by_biorealm.R")
source("scripts/04_plots/vertdif_by_biorealm.R")

sessumm = dat %>% 
  filter(vertvar == "SES Mean Verticality") %>% 
  group_by(class, biome) %>% 
  summarize(mean.reldif = mean(est.reldif)) %>% 
  arrange(mean.reldif) %>% 
  as.data.frame()

meansumm = dat %>% 
  filter(vertvar == "Mean Verticality") %>% 
  group_by(class, biome) %>% 
  summarize(mean.reldif = mean(est.reldif)) %>% 
  arrange(mean.reldif) %>% 
  as.data.frame()

load("results/sdmTMB_models/amphibians_sesvert.RData")
amph.sesvert = pred.f
amph.sesvert$vertvar = "SES Mean Verticality"
amph.sesvert$est.reldif = pred.f$est.dif/(max(pred$vert.mean.ses) - min(pred$vert.mean.ses))*100

amphses.minreldif = round(min(amph.sesvert$est.reldif),2)
amphses.maxreldif = round(max(amph.sesvert$est.reldif),2)

load("results/sdmTMB_models/amphibians_meanvert.RData")
amph.meanvert = pred.f
amph.meanvert$vertvar = "Mean Verticality"
amph.meanvert$est.reldif = pred.f$est.dif/(max(pred$vert.mean) - min(pred$vert.mean))*100

amphmean.minreldif = round(min(amph.meanvert$est.reldif),2)
amphmean.maxreldif = round(max(amph.meanvert$est.reldif),2)


```

Changes in verticality in response to projected climate change were small relative to the total variation in mean and SES verticality and varied across taxa (Fig. \@ref(fig:vert-dif-map)). However, our future projections show small declines in verticality across tropical regions for all taxonomic groups. Amphibians exhibited the highest predicted relative percent change, with the SES and mean of verticality expected to decrease by up to 5% in parts of the tropics, whereas a 4.4-5.1% increase is projected along the African forest-savanna matrix. For all other taxa, changes in verticality are expected to vary less than 1.5%. Within biomes, the models predicted the highest relative decreases in verticality in tropical and subtropical moist forests and the highest relative increases at high latitudes in boreal forests. Within these biomes, the models predicted the greatest average relative decrease for amphibians (SES verticality: `r round(sessumm[1, "mean.reldif"], 2)`%, mean verticality: `r round(meansumm[1, "mean.reldif"], 2)`%)) and the greatest average relative increase for birds (SES verticality: `r round(sessumm[which(sessumm$class == "Birds" & sessumm$biome == "Boreal Forests/Taiga"), "mean.reldif"], 2)`%, mean verticality: `r round(meansumm[which(meansumm$class == "Birds" & meansumm$biome == "Boreal Forests/Taiga"), "mean.reldif"], 2)`%) (Fig. S\@ref(fig:vert-dif-biome)).

# Discussion

Understanding global patterns and drivers of verticality is key to understanding how vertical habitat use mediates species richness gradients. Our results reveal globally consistent patterns of animal verticality in wooded biomes, with epicenters of verticality in the wet tropics and declining verticality toward the poles (Fig. \@ref(fig:vert-map-global)). 

## Climatic drivers of verticality

Climate influences global patterns of verticality because more extreme climates in the canopy, including increased exposure to hot, cold, and dry conditions, pose physiological challenges to living in arboreal habitats in regions where macroclimate conditions are also more extreme [@oliveiraVerticalStratificationInfluences2019]. Consistently high precipitation facilitates verticality, while temperatures at both hot and cold extremes and low precipitation generally limit verticality. For example, more severe water limitation in the canopy than the understory [@scheffersIncreasingArborealityAltitude2013] may contribute to observed declines in arboreal life strategies outside moist tropical forests. However, our models indicated nuanced influences of drivers across taxa.

Precipitation strongly influenced amphibian verticality, while a combination of precipitation and maximum temperatures influenced bird verticality. In tropical wet forests, consistent water availability from precipitation and/or fog allows amphibians and birds to maintain body temperatures below critical thermal maxima via evapotranspiration while avoiding desiccation [@mckechnieAvianThermoregulationHeat2017; @sundayThermalsafetyMarginsNecessity2014]. In tropical regions with pronounced dry seasons, amphibians and birds may increase their use of understory habitats to avoid desiccation, reducing assemblage verticality [@bashamVerticalStratificationCollapses2020; @rajaonariveloSeasonalVariationVertical2021]. In many temperate or boreal biomes, low precipitation similarly constrains amphibian arboreality, where basking to increase body temperatures can quickly lead to desiccation without adequate moisture availability or physiological defenses [@sundayThermalsafetyMarginsNecessity2014; @tracyNotJustSmall2010].

For mammals and reptiles, our models indicated that cold temperatures had the greatest impact on verticality. In boreal forests, cold and windy conditions in the canopy can cause body temperatures to drop below critical thermal minima in ectotherms and pose large energetic costs to endotherms [@bymanEnergeticCostsWinter1988; @sundayThermalsafetyMarginsNecessity2014]. Limited food availability in the canopy may exacerbate high energy demands for arboreal strategies in these ecosystems. Species are therefore largely constrained to thermally buffered terrestrial or fossorial microhabitats [@bymanEnergeticCostsWinter1988; @sundayThermalsafetyMarginsNecessity2014]. 


## Canopy height, verticality, and richness

At a global scale, our findings indicate positive relationships between both canopy height and verticality and verticality and species richness (barring reptiles; Figs. \@ref(fig:mod-coefs), \@ref(fig:richness-mods). The co-occurrence of these patterns suggests that verticality may mediate positive relationships between canopy height and richness via niche expansion, which have been observed for several taxonomic groups, including birds, mammals, and amphibians [@fengForestCanopyHeight2020; @macarthurBirdSpeciesDiversity1961; @rollLinkingVertebrateSpecies2015]. Therefore, from high latitude boreal forests to the equatorial tropics, increasing tree height [@langHighresolutionCanopyHeight2023] combined with macroclimate conditions that facilitate arboreality allow the addition of arboreal species to assemblages, increasing both verticality and species richness (Fig. \@ref(fig:concept-fig)) [@oliveiraVerticalStratificationInfluences2019].

At a regional scale, positive relationships between both verticality and richness and verticality and canopy height were limited to small regions within the tropics where relatively rapid increases in vegetation height from high to low elevations (e.g., the Andes) or dry to wet forests (e.g., Madagascar) may facilitate the addition of arboreal species to novel habitat space [@verschuylEffectForestStructure2008; @pellissierNichePackingExpansion2018]. These regions generally correspond to previously reported spatially varying impacts of canopy height on taxonomic and functional richness [@rollLinkingVertebrateSpecies2015; @fengForestCanopyHeight2020; @coopsDisentanglingVegetationClimate2018]. For example, canopy height positively affects verticality and richness of amphibians in Madagascar, the Andes, Central America, Southern India, and New Guinea, birds in the Himalayas, New Guinea, and southeastern Australia, and mammals in northwestern Mexico and eastern Madagascar, while negative effects occur for mammals in parts of the Amazon basin (Fig. \@ref(fig:svc)) [@rollLinkingVertebrateSpecies2015; @fengForestCanopyHeight2020; @coopsDisentanglingVegetationClimate2018]. The co-occurrence of these patterns further supports the roll of verticality in mediating relationships between canopy height and richness in select regions.

Yet, positive relationships between verticality and richness still occurred across most tropical biomes for all taxa except reptiles despite neutral relationships between canopy height and verticality. These results are consistent with Basham et al. [-@bashamVerticalStratificationPatterns2023a], who found non-significant impacts of canopy height on verticality in the tropics using meta-analysis. In these regions, verticality may facilitate increasing species richness without coincident increases in canopy height via niche packing, which occurs when smaller niche spaces or greater niche overlap allow more species to coexist in a habitat (Fig. \@ref(fig:concept-fig)); @pigotFunctionalTraitsReveal2016; @pellissierNichePackingExpansion2018). Recent analyses of tropical forest structure support this mechanism, with large swaths of tropical forest exhibiting limited vertical stratification of vegetation, which was identified as a single (rather than multiple) peaks in foliage density from the ground to the canopy [@doughtyTropicalForestsAre2023]. In the absence of increasing canopy height, specialization on specific resources within the canopy over evolutionary time combined with generally faster diversification rates of arboreal lineages could increase arboreal species diversity, assemblage verticality, and total richness [@fengForestCanopyHeight2020; @cyriacDiggingTheirOwn2018; @liWhatDrivesDiversification2022; @moenMicrohabitatClimaticNiche2017; @pellissierNichePackingExpansion2018].

In temperate and boreal regions, where canopy height had a neutral impact on verticality (Fig. \@ref(fig:svc)) and verticality and richness exhibited negative or shallow positive slopes (Fig. \@ref(fig:richness-mods)), climatic constraints on arboreal lifestyles may prevent expansion across vertical forest strata or packing within the canopy [@oliveiraVerticalStratificationInfluences2019], thus limiting positive relationships between canopy height, verticality, and species richness [@larueDiversityVolumeRelationships2023]. For taxa that exhibit fossorial strategies, negative correlations between verticality and richness could, in contrast, be caused by expansion vertically downward rather than upward. More nuanced data on the degree of arboreality (opposed to categorical vertical strategy data) would be required to verify patterns of niche expansion and packing.

## Impacts of climate change on verticality

Increasing temperature and altered precipitation patterns could have minor impacts on global patterns of assemblage verticality based on our models via vertical niche shifts, range shifts, or local extinction (Fig. \@ref(fig:vert-dif-map)). For example, arboreal species could spend more time in the understory to avoid unsuitable climate conditions in the canopy that may increase in frequency with the rising magnitude and frequency of extreme heat and drought events [@sundayThermalsafetyMarginsNecessity2014; @bashamVerticalStratificationCollapses2020; @ipccClimateChange20232023]. Indeed, vertical niche shifts have been observed at smaller spatiotemporal scales across tropical forests and taxa (e.g. birds, @delgado-martinezDifferentialUtilizationSurface2023; frogs, @bashamVerticalStratificationCollapses2020; primates, @eppleyFactorsInfluencingTerrestriality2022). However, logging and deforestation may have more immediate effects by reducing the availability of arboreal habitats and increasing local temperatures, potentially generating more extreme shifts in verticality [@lindenmayerResponseArborealMarsupials2021; @nowakowskiChangingThermalLandscapes2018; @seniorPantropicalAnalysisImpacts2017]. 

Increasing minimum cold temperatures could release constraints on arboreality in temperate and boreal regions for birds and mammals. Verticality could subsequently increase as optimal latitudinal ranges of birds living in the upper canopy shift poleward [@laughlinWinterRangeShifts2023; @martinsSignificantShiftsLatitudinal2024]. Range shift induced increases in verticality will likely be restricted to extra-tropical assemblages, because ranges of tropical species typically shift across elevations rather than latitudes [@colwellStillLittleEvidence2024]. Vertical niche shifts are less likely to contribute to increased verticality, because morphology constrains arboreal strategies [@camargoContrastingRealizedFundamental2016; @dealencarArborealityConstrainsMorphological2017]. Yet, use of arboreal habitats by terrestrial species has occasionally been observed in high latitude temperate climates [@petrovanWhyLinkDiverse2022]. 

## Conclusions

We show that verticality exhibits globally consistent patterns across taxa and is constrained by minimum temperatures and low precipitation. Global positive impacts of canopy height on verticality suggest vertical stratification across increasingly tall forests contributes to high species richness in tropical regions. However, neutral regional impacts of canopy height suggest that climatic constraints limit relationships between verticality and richness in boreal and temperate regions, while niche packing contributes to positive relationships between verticality and richness in tropical regions. While predictions of verticality under future climate conditions indicate small changes in global patterns of verticality, understanding the extent to which increases or decreases in verticality are realized and attributable to climate change will require long-term monitoring of taxa and vertical microclimates across latitudes.

\newpage

# References

\newpage

**Data Availability Statement**

All data used are publicly available. Code is available at https://github.com/lysoifer/verticality_future.

\newpage

# Figures

```{r fig.id="concept-fig", fig.width=160, fig.height=100.65, fig.cap.pre="Fig. ", fig.cap="a) Niche expansion: Canopy height positively impacts verticality by allowing species to occupy novel habitat space as canopy height increases. As assemblage verticality increases, species richness also increases. Thus verticality mediates positive relationships that have been observed between canopy height and species richness. b) Niche packing: Canopy height has no impact on verticality or richness, yet verticality and richness are still positively correlated. This pattern could be caused by niche packing within arboreal habitats.", include=TRUE}

knitr::include_graphics("figures/main_figs/fig1_concept_fig.png", error = F)
```


```{r fig.id="vert-map-global", fig.width=180, fig.height=175.52, fig.cap.pre="Fig. ", fig.cap="a) Line plots and b) ternary maps showing the proportion of birds, mammals, reptiles, and amphibians exhibiting arboreal, terrestrial, and fossorial life strategies. In line plots, lines represent the average proportion for a given latitude ± standard deviation. The sum of pProportions may exceed one, because a single species can exhibit multiple strategies. c) The standard effect size (SES) of verticality in wooded biomes. Gray areas indicate areas that are not wooded or that have fewer than five species.", include=TRUE}

knitr::include_graphics("figures/main_figs/fig2_vert_maps/fig2_vert_maps.png", error = F)
```

\newpage

```{r fig.id="mod-coefs", fig.width=160, fig.height=87.3, fig.cap.pre="Fig. ", fig.cap=" Coefficient estimates for the most parsimonious models of SES verticality with 95% confidence intervals. Red points indicate coefficients with 95% CIs that do not overlap zero."}

include_graphics("figures/main_figs/fig3/fig3_sdmTMB_coefs.png", error = F)
```

\newpage

```{r fig.id="cor-plot", fig.width = 180, fig.height=91.35, fig.cap.pre="Fig. ", fig.cap=" Pearson correlation coefficients per biome for relationships between richness and SES verticality (x-axis) and SES verticality and canopy height (y-axis) for a) birds, b) mammals, c) reptiles, and d) amphibians. Colors indicated biome. Black rings indicate significance of the correlation. The outer ring indicates significance of the correlation between verticality and canopy height and the inner ring indicates significance of the correlation between richness and verticality."}

include_graphics("figures/main_figs/fig4/fig4_correlations_annotated.png", error = F)
```

\newpage

```{r fig.id="vert-dif-map", fig.width=180, fig.height=76.94, fig.cap.pre="Fig. ", fig.cap="Difference in predicted vertical between future and present climate conditions for a) birds, b) mammals, c) reptiles, and d) amphibians. Bar plots indicate average difference per latitude. Gray areas indicate areas that are not wooded or that have fewer than five species."}

include_graphics("figures/main_figs/fig5/fig5_vert_difs.png", error = F)
```

\newpage

# Supplementary methods

## Species data

We identified wooded habitats by ecoregions including forests, woodlands, taiga, várzea, Yungas, savanna, thicket, and mallee as defined by Dinerstein et al. [-@dinersteinEcoregionBasedApproachProtecting2017]. The TetrapodTraits dataset uses phylogenetic imputation to identify traits if trait data is not available in the literature. For species where imputation was necessary, we considered a species to use a given vertical stratum if over 70% of the 10,000 imputations predicted use of the stratum.

## Mesh development

The Gaussian random field is approximated using a spatial mesh. We constructed separate meshes for all taxa and for mean and SES verticality using the ‘fmesher’ R package. The mesh used to approximate the spatial Gaussian random field (GRF) impacts model results as well as computational time. To assess sensitivity of the model to the mesh and select the optimal mesh, we used an iterative procedure to update minimum and maximum edge lengths of triangles in the mesh based on the spatial range of the data (i.e., the distance at which points exhibit a correlation of approximately 0.1) [@thorsonSpatioTemporalModelsEcologists2024]. We first estimated the spatial range by visually inspecting spatial correlations based on a subset of 1000 points. To avoid over-smoothing the GRF while simultaneously not over-fitting the model and unnecessarily increasing computational demands, the maximum edge length of triangles within the modeling domain should be several times smaller than the estimated spatial range [@andersonSdmTMBPackageFast2024]. To construct the initial mesh, we specified the maximum edge length of the inner domain as 1/5 the spatial range. Additionally, we specified an inner extension equal to the length of the spatial range, an outer extension equal to twice the length of the spatial range, and the maximum edge length in the outer extension equal to the spatial range. To avoid small triangles, we also specified the minimum edge length as 1/5 the maximum edge length of the inner domain [@krainskiAdvancedSpatialModeling2019]. We then fit a model using the resulting mesh. If the estimated range in the model was less than five times the maximum edge length of the spatial domain used to construct the mesh, we constructed a new mesh, updating the edge lengths and buffers based on the spatial range estimated by the model. We repeated this procedure until the spatial range estimated by the model was greater than 5 times the maximum edge length of the spatial domain used to construct the mesh. We selected the mesh used in the final model for all following analysis.

# Supplementary tables


```{r tab.id="mod-compare-tab", tab.lp="stab", tab.cap="Model selection criteria for models of mean and SES verticality for all four vertebrate taxa. The log-likelihood, AIC, and delta AIC are for models trained with all points. The average log-likelihood is the average sum of log-likelihood values for left out test data across five folds."}
tab = read.csv("tables/supplement/model_selection_compare.csv")

tab = tab %>%
 # filter(response_var == "Mean verticality") %>%
  relocate(taxon) %>%
  relocate(response_var, .after = taxon) %>%
  arrange(taxon, response_var, deltaAIC) %>%
  mutate(taxon = factor(taxon, levels = c("Birds", "Mammals", "Reptiles", "Amphibians"))) %>%
  mutate_at(.vars = c("logLik", "AIC", "deltaAIC", "avg_logLik"), .funs = function(x)round(x, 2))

flextable(tab) %>%
  merge_v(j=~ taxon + response_var) %>%
  hline(i=seq(4,32,4), part = "body",
        border = fp_border(color = "black", width = 3)) %>%
  vline(j = c(1, 2), part = "body",
        border = fp_border(color="black", width = 3)) %>%
  colformat_double(i = ~response_var, j = "taxon") %>%
  fix_border_issues()
```


\newpage

# Supplementary figures

```{r fig.id="vert-biome", fig.lp="suppfig", fig.cap="Average mean and SES verticality for each taxonomic group in global biomes. Error bars indicate standard deviations.", fig.cap.pre="Fig. S", fig.autonum.start_at=1, fig.height=80, fig.width=160}
include_graphics("figures/supp_figs/vert_biome_forestOnly_forestSES.png", error = F)
```

\newpage

```{r fig.id="condeff-mean", fig.lp="suppfig", fig.cap="Conditional effect plots for mean verticality (indicated by blue-red color scale) in response to precipitation of the driest month and maximum temperature of the warmest month. The first column shows mean verticality across gradients of maximum temperature of the warmest month and log(dry season precipitation). The second column shows mean verticality across gradients of minimum temperature of the coldest month and log(dry season precipitation).", fig.cap.pre="Fig. S", height=213.3, width=160}
include_graphics("figures/supp_figs/cond_effects_meanvert.png", error = F)
```

\newpage

```{r fig.id="condeff-ses", fig.lp="suppfig", fig.cap="Conditional effect plots for SES verticality (indicated by blue-red color scale) in response to precipitation of the driest month and maximum temperature of the warmest month. The first column shows SES verticality across gradients of maximum temperature of the warmest month and log(dry season precipitation). The second column shows SES verticality across gradients of minimum temperature of the coldest month and log(dry season precipitation).", fig.cap.pre="Fig. S", height=213.3, width=160}
include_graphics("figures/supp_figs/cond_effects_sesvert.png", error = F)
```

\newpage

```{r fig.id="cor-biome", fig.lp="suppfig", fig.cap="Relationships between richness and mean or SES Verticality for birds, mammals, reptiles, and amphibians in each biome. Lines indicate slopes of linear models for richness as a function of mean or SES verticality.", fig.cap.pre="Fig. S", height=124.5, width=160}
include_graphics("figures/supp_figs/vert_richness_correlations.png", error = F)
```


\newpage

```{r fig.id="vert-dif-biome", fig.lp="suppfig", fig.cap.pre="Fig. S", fig.cap="Average relative percent difference between SES and mean verticality predicted under present and future climate conditions for global biomes. Negative values indicate predicted declines in verticality and positive values indicate predicted increases in verticality. Biomes along the y-axis are ordered from those that were predicted to exhibit the greatest average invrease in verticality across taxa at the top to those that were predicted to exhibit the greatest average decrease in verticality at the bottom.", fig.height=80, fig.width=160}

include_graphics("figures/supp_figs/dif_biome_forestOnly_forestSES.png", error = F)
```

