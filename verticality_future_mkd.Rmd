---
author: ""
title: "Global patterns and drivers of vertebrate verticality"
bibliography: "`r rbbt::bbt_write_bib('docs/r-refs.bib', overwrite = TRUE)`"
output: 
  officedown::rdocx_document:
    reference_docx: "style-guide.docx"
    mapstyles:
      Normal: ['First Paragraph']
plots:
  caption:
    style: Image Caption
    pre: 'Figure '
    sep: ': '
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE, warning=FALSE, message=FALSE, error=FALSE)
library(officedown)
library(officer)
library(tidyverse)
library(spatialreg)
library(data.table)
library(flextable)
library(knitr)
library(chunkhooks)

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)

hook_figure_unit("mm")
```


```{r}
word_comment <- function(
  comment, 
  highlight = "", 
  author = "Lydia", 
  time = Sys.time(),
  id = "0"
) 
{
  if (isTRUE(knitr:::pandoc_to() == "docx")) {
    return(
      sprintf(
        '[%s]{.comment-start id="%s" author="%s" date="%s"} %s []{.comment-end id="%s"}',
        comment,
        id,
        author,
        time,
        highlight,
        id
      )
    )
  } else {
    return(
      sprintf(
        "*%s* **[Comment id %s by %s at time %s: %s]**", 
        highlight,
        id,
        author, 
        time, 
        comment
      )
    )
  }
}
```



# Introduction

In forest ecosystems, species assemblages may be stratified across vertical resource and climate gradients from beneath the ground to the top of the canopy, i.e., vertical stratification [@bashamVerticalStratificationPatterns2023a; @xingEcologicalPatternsProcesses2023]. Tall, multi-layered forests increase both habitat volume and niche opportunities, enabling species to partition across vertical strata akin to multi-floored apartments [@macarthurLimitingSimilarityConvergence1967; @macarthurBirdSpeciesDiversity1961; @larueDiversityVolumeRelationships2023]. This vertical stacking of species has become an emblematic signature of biologically rich regions and is associated with patterns of species richness from local to global scales [@macarthurPopulationEcologyWarblers1958; @macarthurBirdSpeciesDiversity1961; @oliveiraVerticalStratificationInfluences2019; @bashamVerticalStratificationPatterns2023a]. As such, vertical stratification may be a mechanistic link to positive relationships between canopy height and species richness [@culbertInfluenceVerticalHorizontal2013; @fengForestCanopyHeight2020; @gillespieDistributionBirdSpecies2001; @oliveiraVerticalStratificationInfluences2019; @wagnerRemotelySensedTree2023]. However, canopy height does not consistently impact species richness at regional to global scales, with notable declines in the strength of the relationship at poleward latitudes where the diversity of arboreal species generally declines [@larueDiversityVolumeRelationships2023; @rollLinkingVertebrateSpecies2015; @oliveiraVerticalStratificationInfluences2019].

Tall forests contain steep vertical climate gradients characterized by lower thermal variability and greater moisture toward the ground [@scheffersTropicalMountainPasses2018; @leahyVerticalNicheElevation2021; @defrenneGlobalBufferingTemperatures2019]. At temperate and boreal latitudes, low temperature and moisture in the canopy may exceed physiological thresholds and constrain species to lower vertical positions [@oliveiraVerticalStratificationInfluences2019; @bakenSalamanderArborealityLimited2021]. In wet tropical forests, physiological constraints decline, which may allow species to stratify across the entire vertical habitat gradient [@oliveiraVerticalStratificationInfluences2019]. We therefore expect a globally varying relationship between canopy height and verticality pending baseline regional conditions from positive in tropical to neutral in temperate and boreal systems.

Spatial variation may also occur in the relationship between verticality and species richness [@oliveiraVerticalStratificationInfluences2019]. Though prior studies have shown positive relationships between verticality and richness for select taxa, the strength of this relationship is variable and generally more positive in tropical regions where climatic conditions pose fewer physiological constraints on arboreal strategies [@cabralFunctionalTraitsPhylogeny2022; @oliveiraVerticalStratificationInfluences2019]. Niche expansion, characterized by vertical partitioning of the foerst, may allow this pattern to occur. In contrast, the relationship between verticality and richness may be weak where taller canopies do not facilitate higher verticality.

As the climate changes, constraints on arboreal life strategies may shift with potential impacts on assemblage verticality and its association with species richness. In tropical lowlands, increasing temperatures and declining dry season precipitation (*cite*) may pose physiological challenges for arboreal animals and cause them to disperse toward higher elevations, lower vertical positions, or become locally extirpated [@scheffersIncreasingArborealityAltitude2013; @oliveiraVerticalStratificationInfluences2019]. These scenarios would reduce assemblage verticality in the lowlands, akin to studies that show shifts in ecological processes such as climate-induced shifts in assemblage thermal tolerance [@feeleyClimatedrivenChangesComposition2020; @lajeunesseTemporalAnalysisGBIF2023; @chustCrossbasinCrosstaxaPatterns2024; @borderieuxExtinctionDrivesRecent2024]. At poleward latitudes, increasing minimum temperatures could reduce climatic constraints on arboreal species and facilitate range shifts that increase verticality.

```{r}
birds = read.csv("data/derivative_data/species_data/birds_spdat_elton_forestsOnly.csv")
mammals = read.csv("data/derivative_data/species_data/mammals_spdat_moura_forestsOnly.csv")
amph = read.csv("data/derivative_data/species_data/amph_spdat_moura_forestsOnly.csv")
repts = read.csv("data/derivative_data/species_data/rept_spdat_moura_forestsOnly.csv")

nbirds = nrow(birds)
nmammals = nrow(mammals)
namph = nrow(amph)
nrept = nrow(repts)
```

Despite decatdes of ecological inquiry into the relationship between forest height and species richness, little is known as to whether tall forests ubiquitously support niche filling and thus promote greater species coexistence per unit of area (high alpha or gamma diversity) To improve our understanding of the nuances of the relationships between climate, vegetation structure, verticality, and species richness, we integrate range maps of vertebrates (`r nbirds` birds, `r nmammals` mammals, `r nrept` reptiles, and `r namph` amphibians) with climate and vegetation data to examine global patterns and drivers of verticality in wooded biomes. We then examine whether the dynamic of filling vertical niche space and its effects of species richness is informed by the relationship between verticality, canopy height, and climate. Finally, we predict how climate change may impact global patterns of verticality.


# Methods


```{r}
mammals = fread("data/derivative_data/gridcell_data/env_forest/50_km/mammals_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

birds = fread("data/derivative_data/gridcell_data/env_forest/50_km/birds_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

amphibians = fread("data/derivative_data/gridcell_data/env_forest/50_km/amph_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)

rept = fread("data/derivative_data/gridcell_data/env_forest/50_km/reptiles_comdat.csv") %>% 
  dplyr::select(vert.mean, vert.mean.ses, p.arb, p.ter, p.fos, biome, ecoregion, realm)


mammals.arb.tropicalmoist = round(mean(mammals$p.arb[mammals$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
birds.arb.tropicalmoist = round(mean(birds$p.arb[birds$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
rept.arb.tropicalmoist = round(mean(rept$p.arb[rept$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)
amphibians.arb.tropicalmoist = round(mean(amphibians$p.arb[amphibians$biome == "Tropical & Subtropical Moist Broadleaf Forests"], na.rm = T) * 100, 2)

```

## Species data

We mapped verticality and richness of vertebrate assemblages in wooded habitats [@dinersteinEcoregionBasedApproachProtecting2017] using 50 km grid cells and a cylindrical equal area projection (Supplementary methods). Grid cells with fewer than five species were excluded. Range maps were obtained from the IUCN red list for mammals and amphibians [@iucnIUCNRedList2023], BirdLife International for birds [@birdlifeinternationalandhandbookofthebirdsoftheworldBirdSpeciesDistribution2022], and the Global Assessment of Reptile Distributions (GARD) for reptiles [@rollGlobalDistributionTetrapods2017; @caetanoAutomatedAssessmentReveals2022]. For birds, we used breeding plus resident ranges. To calculate the verticality of each assemblage (i.e., grid cell), we assigned each species a verticality score between zero and one and took the average verticality of all species whose ranges overlapped with the grid cell. For mammals, reptiles, and amphibians, verticality scores were based on their use of fossorial (0), terrestrial (0.5), and arboreal (1) habitats as defined in the TetrapodTraits database [@mouraPhylogenyinformedCharacterisationGlobal2024]. For birds, we calculated verticality scores based on their use of different foraging strata as identified in the EltonTraits database [@wilmanEltonTraitsSpecieslevelForaging2014]. We classified foraging below the water surface, around the water surface, and on the ground as 0.5, in the understory as 0.667, mid-high canopy as 0.8337, and in or above the upper canopy as 1. If species used multiple vertical habitats, vertical scores were averaged. For example, if a species occurred in terrestrial (0.5) and arboreal (1) habitats, it would receive a verticality score of 0.75. Species that occupied only aerial vertical niches or that did not occur in terrestrial habitats were excluded from the analysis.

To examine spatial patterns of verticality independently of species richness, we calculated the standard effect size (SES) of mean verticality ($SES = (x_i - \bar{x})/sd(x)$, where x is a vector of expected mean verticality scores given random selection of species from a species pool). We defined species pools as species within all wooded habitats in each biogeographic realm [@dinersteinEcoregionBasedApproachProtecting2017] and generated a null distribution of expected verticality given random chance for each grid cell using 100 simulations.

## Environmental data

We obtained present and future global climate data from CHELSA v2.1 for mean daily maximum air temperature of the warmest month, mean daily minimum air temperature of the coldest month, temperature seasonality, precipitation of the wettest month, precipitation of the driest month, and precipitation seasonality [@kargerDataClimatologiesHigh2021; @kargerClimatologiesHighResolution2017]. Present climate data represents the time period 1981-2010 and future climate data represents an ensemble of climate scenarios for SSP585 for the time period 2071-2100. Vegetation data included canopy height [@langHighresolutionCanopyHeight2023], vegetation density [@crowtherMappingTreeDensity2015], and vegetation complexity (the product of canopy height and vegetation density). Additionally, we included historical climate velocity, which represents the average rate at which thermal isotherms have shifted between the last glacial maximum and present climate conditions [@sandelInfluenceLateQuaternary2011] and has been shown to influence global patterns of verticality [@oliveiraVerticalStratificationInfluences2019]. All environmental data were resampled to the resolution and projection of the species data.

## Analysis

### Variable selection
We examined relationships between mean or SES verticality and the ten environmental variables: canopy height, vegetation density, vegetation complexity, maximum temperature of the warmest month, minimum temperature of the coldest month, temperature seasonality, precipitation of the wettest month, precipitation of the driest month, precipitation seasonality, and climate velocity.  To linearize the relationships between predictor and response variables, we log-transformed climate velocity and precipitation of the driest month. We then scaled all predictor variables to mean zero and variance one. To reduce impacts of collinearity on the model, we examined VIF factors of all variables and sequentially removed one variable at a time until all VIFs were less than 5 [@wartonEcostatsDataAnalysis2022]. We chose variables to remove based on a combination of which had the highest VIF and which were most likely to directly impact physiological limits to arboreality. For example, we excluded precipitation seasonality because it was strongly correlated with dry season precipitation and has a less direct impact on physiological limits to verticality than dry season precipitation. This procedure resulted in a final set of seven variables that included canopy height, vegetation density, maximum temperature of the warmest month, minimum temperature of the coldest month, precipitation of the wettest month, precipitation of the driest month, and climate velocity. The additive effects of these variables were included as fixed effects in the model in addition to a quadratic term for maximum temperature of the warmest month, as we expected that verticality may increase with temperature up to a certain point but then decline under extremely high temperatures.

### Model description

We used spatial generalized linear mixed-effects models (GLMMs) to evaluate the impact of environmental variables on mean and SES verticality. Spatial models were fit using the R package sdmTMB [@andersonSdmTMBPackageFast2024], which fits models using maximum marginal likelihood estimation through template model builder (TMB) and uses the stochastic partial differential equation (SPDE) approach to approximate spatial Gaussian random fields. [@lindgrenExplicitLinkGaussian2011] as implemented in R-INLA [@lindgrenBayesianSpatialModelling2015]. sdmTMB is also able to fit models that include a spatially varying coefficient (SVC), which allow the coefficient of a predictor variable to vary across the study extent, and are better able to detect complex species-environment relationships [@doserGuidelinesUseSpatially2024; @andersonSdmTMBPackageFast2024]. 

The general model can be described as: 

$$
\begin{align}
y_s âˆ¼ ðœ‡_{s}, \\
ðœ‡_s = ð‘“^{-1}(ðœ²^{main}_sð›½ + Î±_g + ðœ²^{svc}_sÎ¶_s + âµ_s), \\
âµ_s âˆ¼ MVNormal(0,ðšº_âµ)
\end{align}
$$

where $y_s$ is mean or SES verticality at location $s$ defined by x and y coordinates, $ðœ‡_s$ is the expected mean or SES verticality, and $ð‘“^{-1}$ represents an inverse link function. We modeled SES verticality as a normal distribution and mean verticality as a beta distribution with a logit link function because values are constrained between 0 and 1. $ðœ²^{main}_s$ is a vector of main effect covariates and ð›½ represents a corresponding vector of estimated main effect coefficients. $Î±_g$ represents a random intercept defined by biogeographic realm [@dinersteinEcoregionBasedApproachProtecting2017], which accounts for potential variation in verticality drive by global evolutionary patterns. $âµ_s$ represents a spatial random field at location $s$, and describes additional spatial variation in the data not explained by the environmental covariates or random intercept. $ðœ²^{svc}_sÎ¶_s$ represents a spatially varying coefficient, where $ðœ²^{svc}$ represents the vector of spatially varying parameter values and $Î¶_s$ represents the spatially varying coefficients, which are described using a random field such that the coefficients follow a multivariate normal distribution with mean zero and covariance ($ðšº_Î¶$). Both the spatial random field and the spatially varying coefficients are modeled as Gaussian random fields with a covariance matrix modeled by the MatÃ©rn covariance function, which defines the decay rate of correlation with distance. Gaussian random fields were approximated for models of mean and SES verticality for each taxa using a spatial mesh optimized such that the edge length was as large as possible to reduce computational time while remaining less than five times the spatial range of the model [@andersonSdmTMBPackageFast2024; @krainskiAdvancedSpatialModeling2019] (Supplementary methods). The model is specified such that both spatial terms share the same range parameter.

### Model comparison and evaluation

For each taxonomic group and type of verticality (i.e., SES or mean verticality), we used restricted maximum likelihood (REML) to fit models with four different random effects structures [@zuurMixedEffectsModels2009]. The base model only included a spatial random field. Subsequent models additionally included biogeographic realm [sensu @dinersteinEcoregionBasedApproachProtecting2017] as a random intercept, a spatially varying coefficient for canopy height, and the combination of both. Including realm as a random intercept accounts for evolutionary differences among biogeographic realms that could lead to differences in verticality. The spatially varying coefficient allows the impact of canopy height on verticality to vary globally and allows us to test the hypothesis that canopy height has a positive effect on verticality only where climatic conditions support arboreality. We compared models using AIC and cross-validation. AIC is frequently used to identify the most parsimonious model [e.g., @barnettImprovingEstimatesSpecies2021]; however, the metric is not completely appropriate for hierarchical models (see Commander et al. 2022 `r word_comment(comment = "check citation", highlight = "Commander et al. 2022")`). Therefore, we additionally used cross-validation to evaluate out-of-sample predictive ability (*again check citation Commander et al. 2022*). We randomly assigned each data point to one of five folds, and then iteratively fit the model using four of the five folds while one fold was withheld for testing. The sum of the log-likelihoods for each left-out fold provides a measure of predictive ability that is compared across models. Cross validation was conducted using the â€˜sdmTMB_cvâ€™ function from the sdmTMB package. Models that included both a spatially varying coefficient for canopy height and geographic realm as a random intercept consistently had the lowest AIC value across all models, while model performance varied based on cross validation (Tabe S\@ref(tab:mod-compare-tab)). Given consistent performance based on AIC and our interest in the SVC, all predictions were made based on the model that included both realm and the SVC. 

We validated models first using the â€˜sanityâ€™ function from the sdmTMB package. We additionally calculated quantile residuals using the DHARMa R package [@hartigDHARMaResidualDiagnostics2022] to visually assess that residuals were normally distributed and lacked patterning across space and to examine any patterns across rank transformed and raw model predictions.

We estimated uncertainty of SVCs for canopy height by adding draws of the SVC random field to draws of the fixed parameter for canopy height from 300 simulations. We then calculated the median and 0.025 and 0.975 quantiles to obtain a 95% confidence interval for each SVC estimate. Confidence intervals that did not overlap zero were considered significant [@andersonSdmTMBPackageFast2024].

## Relationship between verticality and richness

To examine whether the relationship between verticality and canopy height mediates the relationship between verticality and richness, we calculated Pearson correlations between mean or SES verticality and richness for each taxon considering all points and only points where canopy height had a positive significant effect on verticality.

## Future predictions

To examine potential impacts of climate change on assemblage verticality, we used the models to predict mean and SES verticality under a future climate scenario. We held vegetation variables constant at present-day values due to lack of global predictions of future canopy height and vegetation density. We subtracted predictions to the present-day climate data used to train the model from future predictions and mapped the resulting differences. To standardize measures of change across taxa and between mean and SES verticality, we calculated the percent relative change between present and future predictions for mean and SES verticality as $(verticality_{future,t,i} - verticality_{present,t,i})/(verticality_{max,t} - verticality_{min, t})*100$, where t indicates a given taxon and i indicates a given grid cell. Negative values indicate predicted declines in verticality and positive values indicate predicted increases in verticality.

# Results

## Global patterns of verticality

Verticality exhibited a latitudinal gradient across taxa characterized by high verticality in the tropics and lower verticality toward higher latitudes (Fig. \@ref(fig:vert-map-global)). This pattern was largely driven by declines in the proportion of arboreal species toward the poles. Patterns of SES verticality mirrored those of mean verticality and highlight declines in arboreal strategies outside tropical moist forests (Fig. S\@ref(fig:vert-biome)). Within tropical and subtropical biomes, verticality was highest in moist forests and lowest in dry forests (Fig. \@ref(fig:vert-biome)). In moist forests, verticality of bird and mammal assemblages was consistently high, with an average of `r birds.arb.tropicalmoist`% of birds and `r mammals.arb.tropicalmoist`% of mammals exhibiting arboreal strategies. In contrast, amphibian and reptile verticality exhibited clear hotspots, with reptile verticality peaking in Madagascar and Malaysian and Indonesian forests and amphibian verticality peaking in the Brazilian Atlantic forest and eastern Madagascar.

In temperate biomes, verticality was similar across forest types but declined in less dense wooded habitats (e.g., savannas and shrublands) (Fig. S \@ref(fig:vert-biome)). Variation in the proportion of species exhibiting fossorial strategies drove differences in patterns of assemblage verticality among vertebrate classes. Amphibians exhibited the highest proportion of fossorial strategies in temperate biomes (Fig. \@ref(fig:vert-map-global)L), though temperate rainforests (e.g., the Pacific-Northwest of North America) were a notable exception. Mammals exhibited a similar pattern, though the proportion of fossorial species increased to a lesser extent (Fig. \@ref(fig:vert-map-global)F). In contrast, the proportion of fossorial reptiles declined in temperate regions. Low reptile verticality was therefore driven by declines in the proportion of arboreal species and increases in the proportion of terrestrial species. Though no birds exhibit fossorial strategies, a reduction in the proportion of arboreal species still produced a steep latitudinal verticality gradient.

## Environmental drivers of verticality

Spatial GLMMs indicated that verticality was limited by low precipitation across taxa, while impacts of high maximum temperatures, low minimum temperatures, and canopy height varied (Fig. \@ref(fig:mod-coefs)). Across taxa, precipitation of the driest and wettest months positively influenced mean and SES verticality (Fig. \@ref(fig:mod-coefs)). Minimum temperature of the coldest month positively impacted mammal and reptile verticality and did not significantly impact bird and amphibian verticality. Maximum temperatures of the warmest month exhibited a quadratic relationship with bird, reptile, and amphibian verticality and a positive linear relationship with mammal verticality. These patterns resulted in lower verticality at both high and low maximum temperatures in regions without high dry season precipitation for reptiles and amphibians, while verticality increased with temperature across a range of dry season precipitation for birds and mammals (Fig. S\@ref(fig:condeff-mean),\@ref(fig:condeff-ses)). Canopy height had globally positive impacts on SES verticality of reptiles and amphibians and mean verticality of amphibians, and vegetation density had no significant impact on mean or SES verticality of any taxon Fig. (\@ref(fig:mod-coefs)). However, impacts of canopy height varied spatially, exhibiting neutral impacts on verticality across much of the tropics and positive impacts in regions in regions with greater topographic relief, including the Andes, southern India, east-central Africa including the Eastern Arc Mountain Range, and Madagascar (Fig. \@ref(fig:svc), Fig. S\@ref(fig:svc-sig) ). Furthermore, environmental factors were unable to explain extremely high and low verticality as indicated by larger residuals (Fig. S\@ref(fig:resid-plt)).

## Verticality-species richness relationships

When considering all points, Pearson correlations indicated strong positive relationships between SES or mean verticality and species richness for birds and mammals, a weak positive relationship for amphibians, and nearly no relationship for reptiles (Fig. \@ref(fig:corplot)). When we restricted the correlation to only include points where canopy height had a significant positive effect on verticality, the strength of the relationship between SES verticality and richness increased for amphibians and SES verticality of birds, but declined for mammals, reptiles, and mean verticality of birds.

## Climate change impacts

```{r cache=TRUE, cache.path="cache/"}
# calculate percent change in verticality
#source("./../scripts/04_plots/vertdif_by_biorealm.R")
source("scripts/04_plots/vertdif_by_biorealm.R")

sessumm = dat %>% 
  filter(vertvar == "SES Mean Verticality") %>% 
  group_by(class, biome) %>% 
  summarize(mean.reldif = mean(est.reldif)) %>% 
  arrange(mean.reldif) %>% 
  as.data.frame()

meansumm = dat %>% 
  filter(vertvar == "Mean Verticality") %>% 
  group_by(class, biome) %>% 
  summarize(mean.reldif = mean(est.reldif)) %>% 
  arrange(mean.reldif) %>% 
  as.data.frame()

load("results/sdmTMB_models/amphibians_sesvert.RData")
amph.sesvert = pred.f
amph.sesvert$vertvar = "SES Mean Verticality"
amph.sesvert$est.reldif = pred.f$est.dif/(max(pred$vert.mean.ses) - min(pred$vert.mean.ses))*100

amphses.minreldif = round(min(amph.sesvert$est.reldif),2)
amphses.maxreldif = round(max(amph.sesvert$est.reldif),2)

load("results/sdmTMB_models/amphibians_meanvert.RData")
amph.meanvert = pred.f
amph.meanvert$vertvar = "Mean Verticality"
amph.meanvert$est.reldif = pred.f$est.dif/(max(pred$vert.mean) - min(pred$vert.mean))*100

amphmean.minreldif = round(min(amph.meanvert$est.reldif),2)
amphmean.maxreldif = round(max(amph.meanvert$est.reldif),2)


```


Changes in verticality in response to climate change were small relative to the total variation in mean and SES verticality and varied across taxa (Fig. \@ref(fig:vert-dif-map)). Amphibians exhibited the highest predicted relative percent change, with predicted declines reaching up to `r amphses.minreldif*-1`% for SES verticality and `r amphmean.minreldif*-1`% for mean verticality in parts of the tropics and predicted increases reaching up to `r amphses.maxreldif`% for SES verticality and `r amphmean.maxreldif`% for mean verticality in the African forest-savanna matrix. Across biomes, the models predicted the highest relative declines in verticality in tropical and subtropical moist forests and the highest relative increases at high latitudes in boreal forests. Within these biomes, the models predicted the greatest average relative decline for amphibians (SES verticality: `r round(sessumm[1, "mean.reldif"], 2)`%, mean verticality: `r round(meansumm[1, "mean.reldif"], 2)`%) and the greatest average relative increase for birds (SES verticality: `r round(sessumm[which(sessumm$class == "Birds" & sessumm$biome == "Boreal Forests/Taiga"), "mean.reldif"], 2)`%, mean verticality: `r round(meansumm[which(meansumm$class == "Birds" & meansumm$biome == "Boreal Forests/Taiga"), "mean.reldif"], 2)`%) (Fig. S\@ref(fig:vert-dif-biome)).


# Discussion

Our results indicate globally consistent macroscale patterns of verticality across taxa that are characterized by declining verticality toward higher latitudes and correspond with previous studies that are more limited in taxonomic or spatial extent [@bashamVerticalStratificationPatterns2023a; @oliveiraVerticalStratificationInfluences2019]. Though climate conditions influenced verticality, they were neither able to predict extremely high or low verticality nor spatial variation in the influence of canopy height on verticality. Furthermore, regions exhibiting positive relationships between canopy height and verticality did not consistently exhibit stronger positive relationships between canopy height and species richness. We propose that the rate of niche packing across evolutionary time spans rather than expansion across tall forests may explain both the limited capacity for climate alone to predict high levels of verticality and the lack of the three-way positive relationship between canopy height, verticality, and species richness for some taxa. Given the potentially large role of evolutionary patterns in global distributions of verticality, our models may underpredict the impacts of climate change on vertical assemblage structure.

## Environmental drivers of verticality

Climate influences global patterns of verticality because more extreme climates in the canopy, including increased exposure to hot, cold, and dry conditions, pose physiological challenges to living in arboreal habitats [@oliveiraVerticalStratificationInfluences2019]. Water availability therefore facilitates verticality, while temperatures at both hot and cold extremes and water scarcity generally limit verticality. For example, more severe water limitation in the canopy than the understory [@scheffersIncreasingArborealityAltitude2013] may contribute to observed declines in arboreal life strategies outside moist forests in tropical regions. However, our models indicated nuances in the relative influences of different drivers across taxa.

Impacts of precipitation were particularly pronounced for amphibian verticality. In tropical wet forests, consistent water availability allows amphibians to maintain body temperatures below critical thermal maxima via evapotranspiration [@sundayThermalsafetyMarginsNecessity2014]. However, in regions that experience pronounced dry seasons, amphibians may behaviorally thermoregulate to avoid desiccation by increasing their use of understory habitats, which reduces assemblage verticality [@bashamVerticalStratificationCollapses2020]. Lower precipitation poses a similar constraint to arboreality for amphibians in dry regions at higher latitudes where basking to increase body temperatures can quickly lead to desiccation without adequate moisture availability or physiological defenses [@sundayThermalsafetyMarginsNecessity2014; @tracyNotJustSmall2010].

For mammals and reptiles, our models indicated that minimum cold temperatures had the greatest impact on verticality. In boreal forests, cold and windy conditions in the canopy pose large energetic costs to endotherms and can cause body temperatures to drop below critical thermal minima in ectotherms [@bymanEnergeticCostsWinter1988; @sundayThermalsafetyMarginsNecessity2014]. Species are therefore largely constrained to terrestrial or fossorial habitats, which are buffered from minimum temperature extremes [@defrenneGlobalBufferingTemperatures2019]. Yet despite the limiting or facilitative impacts that climate can have on verticality, climate conditions in combination with vegetation structure failed to predict extremely high and low verticality when the spatial random field was excluded from predictions, suggesting other factors influence global patterns of verticality.

## Spatially varying relationships between canopy height, verticality, and richness

Our models indicated that canopy height has a variable and often insignificant impact on verticality, even across much of the tropics where tall, multi-layered forests would be expected to promote vertical expansion and high diversity of arboreal species [@burnsGriddedGEDIVegetation2024; @fengForestCanopyHeight2020; @rollLinkingVertebrateSpecies2015]. These results correspond to Basham et al. [-@bashamVerticalStratificationPatterns2023a], who similarly found an insignificant impact of canopy height on verticality within the tropics. Interestingly, previously reported spatial variation in the impact of canopy height on taxonomic and functional richness mirror, to some extent, spatial variation in the impacts of canopy height on verticality [@rollLinkingVertebrateSpecies2015; @fengForestCanopyHeight2020; @coopsDisentanglingVegetationClimate2018]. For example, canopy height positively impacts verticality and species richness of amphibians in Madagascar, the Andes, Central America, Southern India, and New Guinea [@rollLinkingVertebrateSpecies2015]. Spatially concurrent positive impacts for birds occur in the Himalayas, New Guinea, and southeastern Australia, while for mammals they occur in northwestern Mexico and eastern Madagascar [@coopsDisentanglingVegetationClimate2018; @rollLinkingVertebrateSpecies2015]. Additionally, concurrent negative impacts for mammals occur in parts of the Amazon basin (Fig. S\@ref(fig:svc-sig)) [@rollLinkingVertebrateSpecies2015; @fengForestCanopyHeight2020]. Given spatial similarities in relationships between canopy height and both verticality and richness, we expected stronger positive correlations between verticality and richness in regions where canopy height positively impacted verticality. Yet, our results did not consistently support this hypothesis.

A niche expansion model of community assembly characterizes the hypothesis that taller canopies with greater foliage height diversity allow greater vertical stratification and subsequent increases in verticality and species richness [@macarthurBirdSpeciesDiversity1961; @macarthurPatternsSpeciesDiversity1965]. The niche expansion model posits that species richness increases when additional species occupy novel habitat or resource space [@pellissierNichePackingExpansion2018; @pigotFunctionalTraitsReveal2016]. Thus, arboreal species may be added to the assemblage by occupying the novel habitat space that becomes available as canopy height increases, producing a stronger positive relationship between verticality and richness in regions where canopy height has a positive influence on verticality. This pattern was evident for birds and amphibians. However, this three-way positive relationship did not occur in the most diverse regions, including much of the tropics. Instead, it was largely restricted to areas where relatively rapid increases in vegetation structure from high to low elevations or dry to wet forests (e.g., Madagascar) may facilitate the addition of species outside the habitat space occupied by species with lower richness in less productive habitats [@verschuylEffectForestStructure2008; @pellissierNichePackingExpansion2018]. Yet in regions where canopy height did not have significant positive impacts on verticality, positive correlations between verticality and richness remained for birds and amphibians and increased in strength for mammals and reptiles, suggesting vertical stratification (i.e., niche expansion) may not be the dominant mechanism causing positive relationships between canopy height, verticality, and species richness at large spatial scales.

Rather than expansion across tall forests, positive associations between verticality and species richness could be driven by niche packing. Niche packing occurs when smaller niche spaces or greater niche overlap allow more species to co-exist within a habitat [@pigotFunctionalTraitsReveal2016; @pellissierNichePackingExpansion2018]. Specialization on specific resources within the canopy over evolutionary time could thus increase arboreal species diversity in the absence of increasing canopy height [@fengForestCanopyHeight2020; @pellissierNichePackingExpansion2018]. Furthermore, evolutionary rates of arboreal lineages are generally faster than those of terrestrial and fossorial lineages [@cyriacDiggingTheirOwn2018; @liWhatDrivesDiversification2022; @moenMicrohabitatClimaticNiche2017]. In the tropics where climate conditions support arboreality, the combination of niche packing and rapid evolutionary rates of arboreal species could thus lead to a disproportionately high number of arboreal species, increasing verticality relative to what would be expected by climate conditions alone and causing positive relationships between verticality and richness in regions where canopy height has insignificant or even negative effects on verticality.

## Impacts of climate change on verticality

Increasing temperature and declining precipitation could alter global patterns of assemblage verticality via vertical niche shifts, range shifts, or local extinction. Our models indicated relatively small declines of verticality in tropical latitudes in response to climate change at a global scale. In the absence of climatic buffering experienced in the understory, species living in arboreal habitats may be threatened by the increasing magnitude and frequency of extreme heat and drought [@ipccClimateChange20232023]. The largest predicted declines in verticality occurred for amphibians in the tropics, corresponding with small thermal safety margins of tropical relative to temperate ectotherms [@sundayThermalsafetyMarginsNecessity2014]. To avoid unsuitable conditions that exceed physiological tolerances, species could behaviorally regulate climate exposure by spending more time in the understory, thus reducing assemblage verticality [@sundayThermalsafetyMarginsNecessity2014; @bashamVerticalStratificationCollapses2020]. Indeed, vertical niche shifts have been observed at smaller spatiotemporal scales across tropical forests. For example, birds and arboreal frogs increase their use of understory resources during the dry season [@delgado-martinezDifferentialUtilizationSurface2023; @bashamVerticalStratificationCollapses2020]. Arboreal primates from the Americas to Madagascar similarly increase their use of terrestrial habitats under hotter temperatures [@eppleyFactorsInfluencingTerrestriality2022]. Alternatively, arboreal species could become locally extinct if they are not able to adjust microhabitat use to avoid extreme climate conditions.

Increasing minimum cold temperatures could release constraints on arboreality in temperate and boreal regions for birds and mammals. Our models predicted the highest increases in verticality in boreal forests, which could occur, for example, as optimal latitudinal ranges of birds in low latitude assemblages with higher verticality shift poleward [@laughlinWinterRangeShifts2023; @martinsSignificantShiftsLatitudinal2024]. Increases in verticality caused by range shifts will likely be restricted to extra-tropical assemblages, because the ranges of tropical species typically move across elevational rather than latitudinal gradients in response to climate change [@colwellStillLittleEvidence2024]. Vertical niche shifts are less likely to contribute to increases in verticality due to morphological constraints on arboreal strategies [@camargoContrastingRealizedFundamental2016; @dealencarArborealityConstrainsMorphological2017]. Yet, use of arboreal habitats by terrestrial species has occasionally been observed in high latitude temperate climates [@petrovanWhyLinkDiverse2022].

Despite the small changes in verticality predicted by our models under future climate scenarios, realized change, particularly declines in verticality, may be larger. First, underprediction of declines may arise because warming and drying climates could impact a disproportionate number of arboreal species in the tropics where climate alone failed to predict high verticality. Second, habitat loss caused by logging and deforestation may have more immediate effects on the vertical structure of species assemblages than climate change [@lindenmayerResponseArborealMarsupials2021; @murrayClimateLandUse2021]. Understanding the extent to which increases or decreases in verticality are realized and attributable to climate change will require long-term monitoring of taxa and vertical microclimates across latitudes.


# Figures

```{r fig.id="vert-map-global", fig.width=160, fig.height=96, fig.cap.pre="Fig. ", fig.cap="SES and mean verticality of birds, mammals, reptiles, and amphibians. Line plots indicate the average proportion of arboreal (red), terrestrial (yellow), and fossorial (blue) species across latitudes. Gray areas indicate areas that are not wooded or that have fewer than five species.", include=TRUE}

knitr::include_graphics("figures/main_figs/vert_maps.png", error = F)
```

\newpage

```{r fig.id="mod-coefs", fig.width=160, fig.height=87.3, fig.cap.pre="Fig. ", fig.cap="Coefficient estimates for models of mean and SES verticality with 95% confidence intervals. Red points indicate coefficients with 95% CIs that do not overlap zero. tmin_cold = minimum temperature of the coldest month, tmax_warm = maximum temperature of the warmest month, precip_dry = precipitation of the driest month, precip_wet = precipitation of the wettest month, veg_den = vegetation density, clim_velocity = climate velocity"}

include_graphics("figures/main_figs/sdmTMB_coefs.png", error = F)
```

\newpage

```{r fig.id="svc", fig.width=160, fig.height=143.95, fig.cap.pre="Fig. ", fig.cap="Spatially varying coefficients for canopy height in models GLMMs of SES and mean verticality for birds, mammals, reptiles, and amphibians. Gray areas indicate areas that are not wooded or that have fewer than five species."}

include_graphics("figures/main_figs/canopy_height_coefs.png", error = F)
```

\newpage

```{r fig.id="corplot", fig.width = 160, fig.height=213.4, fig.cap.pre="Fig. ", fig.cap="Correlation between richness and SES verticality (A-D) or mean verticality (E-H) for all points and for points where the canopy height coefficient was significant and positive. "}

include_graphics("figures/main_figs/vert_rich_cor.png", error = F)
```

\newpage

```{r fig.id="vert-dif-map", fig.width=160, fig.height=133.3, fig.cap.pre="Fig. ", fig.cap="Relative percent change in SES and mean verticality for birds, mammals, reptiles, and amphibians. Bar plots indicate average relative percent change per latitude. Gray areas indicate areas that are not wooded or that have fewer than five species."}

include_graphics("figures/main_figs/vert_reldifs.png", error = F)
```

\newpage

# Supplementary methods

## Species data

We identified wooded habitats by ecoregions including forests, woodlands, taiga, vÃ¡rzea, Yungas, savanna, thicket, and mallee as defined by Dinnerstein et al. (2017). The TetrapodTraits dataset uses phylogenetic imputation to identify traits if trait data is not available in the literature. For species where imputation was necessary, we considered a species to use a given vertical stratum if the imputation probability exceeded 0.7.

## Mesh development

The Gaussian random field is approximated using a spatial mesh. We constructed separate meshes for all taxa and for mean and SES verticality using the â€˜fmesherâ€™ R package. The mesh used to approximate the spatial Gaussian random field (GRF) impacts model results as well as computational time. To assess sensitivity of the model to the mesh and select the optimal mesh, we used an iterative procedure to update minimum and maximum edge lengths of triangles in the mesh based on the spatial range of the data (i.e., the distance at which points exhibit a correlation of approximately 0.1) [@thorsonSpatioTemporalModelsEcologists2024]. We first estimated the spatial range by visually inspecting spatial correlations based on a subset of 1000 points. To avoid over-smoothing the GRF while or over-fitting the model and unnecessarily increasing computational demands, the maximum edge length of triangles within the modeling domain should be several times smaller than the estimated spatial range [@andersonSdmTMBPackageFast2024]. To construct the initial mesh, we specified the maximum edge length of the inner domain as 1/5 the spatial range. Additionally, we specified, an inner extension equal to the length of the spatial range, an outer extension equal to twice the length of the spatial range, and the maximum edge length in the outer extension equal to the spatial range. To avoid small triangles, we also we specified the minimum edge length as 1/5 the maximum edge length of the inner domain [@krainskiAdvancedSpatialModeling2019]. We then fit a model using the resulting mesh. If the estimated range in the model was less than five times the maximum edge length of the spatial domain used to construct the mesh, we constructed a new mesh, updating the edge lengths and buffers based on the spatial range estimated by the model. We repeated this procedure until the spatial range estimated by the model was greater than 5 times the maximum edge length of spatial domain used to construct the mesh. We selected the mesh used in the final model for all following analysis.

# Supplementary tables


```{r tab.id="mod-compare-tab", tab.lp="stab", tab.cap="Model selection criteria for models of mean and SES verticality for all four vertebrate taxa. The log-likelihood, AIC, and delta AIC are for models trained with all points. The average log-likelihood is the average sum of log-likelihood values for left out test data across five folds. NA values are caused by not meeting all model assumptions across all five cross-validation folds."}
tab = read.csv("tables/supplement/model_selection_compare.csv")

tab = tab %>%
 # filter(response_var == "Mean verticality") %>%
  relocate(taxon) %>%
  relocate(response_var, .after = taxon) %>%
  arrange(taxon, response_var, deltaAIC) %>%
  mutate(taxon = factor(taxon, levels = c("Birds", "Mammals", "Reptiles", "Amphibians"))) %>%
  mutate_at(.vars = c("logLik", "AIC", "deltaAIC", "avg_logLik"), .funs = function(x)round(x, 2))

flextable(tab) %>%
  merge_v(j=~ taxon + response_var) %>%
  hline(i=seq(4,32,4), part = "body",
        border = fp_border(color = "black", width = 3)) %>%
  vline(j = c(1, 2), part = "body",
        border = fp_border(color="black", width = 3)) %>%
  colformat_double(i = ~response_var, j = "taxon") %>%
  fix_border_issues()
```


# estimated coefficients and confidence intervals from the best model for each taxa - include all model parameters: fixed effects, spatial paramters (matern range, marginal spatial standard, deviation), distribution parameters

\newpage

# Supplementary figures

```{r fig.id="vert-biome", fig.lp="suppfig", fig.cap="Average mean and SES verticality for each taxonomic group in global biomes. Error bars indicate standard deviations.", fig.cap.pre="Fig. S", fig.autonum.start_at=1, fig.height=80, fig.width=160}
include_graphics("figures/supp_figs/vert_biome_forestOnly_forestSES.png", error = F)
```

\newpage

```{r fig.id="condeff-mean", fig.lp="suppfig", fig.cap="Conditional effect plots for mean verticality in response to precipitation of the driest month and maximum temperature of the warmest month.", fig.cap.pre="Fig. S", height=213.3, width=160}
include_graphics("figures/supp_figs/cond_effects_meanvert.png", error = F)
```

\newpage

```{r fig.id="condeff-ses", fig.lp="suppfig", fig.cap="Conditional effect plots for SES verticality in response to precipitation of the driest month and maximum temperature of the warmest month.", fig.cap.pre="Fig. S", height=213.3, width=160}
include_graphics("figures/supp_figs/cond_effects_sesvert.png", error = F)
```

\newpage

```{r fig.id="svc-sig", fig.lp="suppfig", fig.cap.pre="Fig. S", fig.cap="Areas in which the spatially varying coefficient for canopy height had a significant positive or negative effect on SES or mean verticality of birds, mammals, reptiles, and amphibians.", fig.height=143.9, fig.width=160}

include_graphics("figures/supp_figs/svc_canopyHeight_sig_link.png", error = F)
```

\newpage

```{r fig.id="resid-plt", fig.lp="suppfig", fig.cap.pre="Fig. S", fig.cap="A smoothed scatter plot of quantile residuals as a function of SES or mean verticality, plotted using the DHARMa R package. Red line indicates a spline regression and red dots indicate outliers.", fig.height=213.3, fig.width=160}

include_graphics("figures/supp_figs/resid_plots.png", error = F)

```


\newpage

```{r fig.id="vert-dif-biome", fig.lp="suppfig", fig.cap.pre="Fig. S", fig.cap="Average percent relative difference between SES and mean verticality predicted under present and future climate conditions for global biomes. Negative values indicate predicted declines in verticality and positive values indicate predicted increases in verticality. Biomes along the y-axis are ordered from those that were predicted to exhibit the greatest average in verticality across taxa at the top to those that were predicted to exhibit the greatest average decrease in verticality at the bottom.", fig.height=80, fig.width=160}

include_graphics("figures/supp_figs/dif_biome_forestOnly_forestSES.png", error = F)
```


# References
